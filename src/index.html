<!DOCTYPE html>
<html lang="en">
    <head>
        <link href="styles.css" rel="stylesheet">
        <link href="card.css" rel="stylesheet">

        <script src="card.js" defer></script>
 
        <title>Twenty Eight</title>
    </head>

    <body class="body-content">
        <div class="container" id="start">
            <h1>28</h1>
            <input type="text" placeholder="Name" id="name"/>
            <input type="text" placeholder="Room Code" id="code"/>
            <button id="join">Join Room</button>
            <button id="create">Create Room</button>
        </div>

        <h2 class="hidden" id="roomCode">Room Code: 6PYX1</h2>
        <div class="container hidden" id="lobby">
            <h1>28</h1>
            <ul id="playerList">
            </ul>
            <button>Start Game</button>
            <button>Leave Game</button>
        </div>
    </body>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js";

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyAoUBDg6zn_-nmzB949LfQLE3cBF6U8VTs",
            authDomain: "twenty-eight-a7ba6.firebaseapp.com",
            databaseURL: "https://twenty-eight-a7ba6-default-rtdb.firebaseio.com",
            projectId: "twenty-eight-a7ba6",
            storageBucket: "twenty-eight-a7ba6.appspot.com",
            messagingSenderId: "566672343220",
            appId: "1:566672343220:web:1bdff83862b9f2e23c17e1",
            measurementId: "G-982J38XWP6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);

        import { getDatabase, set, get, update, remove, ref, child } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

        const db = getDatabase();

        var name = document.querySelector("#name");
        var code = document.querySelector("#code");
  
        var joinBtn = document.querySelector("#join");
        var createBtn = document.querySelector("#create");

        var room;
        var playerID;

        var players;

        function createRoom() {
            const characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            let roomID = "";
            const charactersLength = characters.length;

            for (let i = 0; i < 5; i++) {
                roomID += characters.charAt(Math.floor(Math.random() * charactersLength));
            }

            const suits = ['Spades', 'Hearts', 'Diamonds', 'Clubs'];
            const ranks = ['A', 'K', 'Q', 'J', '10', '9'];
            const cards = {};
            let index = 0;

            for (const suit of suits) {
                for (const rank of ranks) {
                    cards[index] = `${rank} ${suit}`;
                    index++;
                }
            }

            set(ref(db, "rooms/" + roomID),{
                players: {
                    0: {
                        name: name.value,
                    }
                },
                turn: 0,
                trumpcard: "",
                callpoints: 0,
                curpoints: 0,
                caller: 0,
                cards: cards,
                started: false,
            })
            .then(()=>{
                console.log("Room Created");

                room = roomID;
                playerID = 0;

                document.getElementById("roomCode").innerHTML = `Room Code: ${room}`;
                document.getElementById("start").classList.add("hidden");
                document.getElementById("roomCode").classList.remove("hidden");
                document.getElementById("lobby").classList.remove("hidden");

                var ul = document.getElementById("playerList");
                var li = document.createElement("li");
                li.appendChild(document.createTextNode(name.value));
                li.setAttribute("id", "0");
                ul.appendChild(li);
                li.classList.add("me");
            })
            .catch((error)=>{
                alert(error);
            });
        }

        function joinRoom() {
            const dbref = ref(db);

            if (code.value == "") {
                alert("Please enter a code");
                return;
            }

            get(child(dbref, "rooms/" + code.value))
            .then((snapshot)=>{
                if(snapshot.exists()){
                    var data = snapshot.val();

                    for (var i = 0; i < data.players.length; i++) {
                        if (data.player[i].name == name.value) {
                            alert("Someone in room has the same name");
                            return;
                        }
                    }

                    room = code.value;
                    playerID = data.players.length;
                    data.players.push({
                        name: name.value,
                    })

                    document.getElementById("roomCode").innerHTML = `Room Code: ${room}`;
                    document.getElementById("start").classList.add("hidden");
                    document.getElementById("roomCode").classList.remove("hidden");
                    document.getElementById("lobby").classList.remove("hidden");

                    update(ref(db, "rooms/" + room, {
                        players: data.players
                    }))
                    .then(()=>{
                        alert("Data updated successfully");
                    })
                    .catch((error)=>{
                        alert(error);
                    });

                    var ul = document.getElementById("playerList");
                    for (var i = 0; i < playerID; i++) {
                        var li = document.createElement("li");
                        li.appendChild(document.createTextNode(data.players[i].name));
                        li.setAttribute("id", `${i}`);
                        ul.appendChild(li);

                        if (i == playerID) {
                            li.classList.add("me");
                        }
                    }
                } else {
                    alert("No room with entered code");
                }
            })
            .catch((error)=>{
                alert(error)
            })
        }

        createBtn.addEventListener("click", createRoom);
        joinBtn.addEventListener("click", joinRoom);
    </script>
</html>