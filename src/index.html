<!DOCTYPE html>
<html lang="en">
    <head>
        <link href="styles.css" rel="stylesheet">
        <link href="card.css" rel="stylesheet">

        <script src="card.js" defer></script>
 
        <title>Twenty Eight</title>
    </head>

    <body class="body-content">
        <div class="container" id="start">
            <h1>28</h1>
            <input type="text" placeholder="Name" id="name"/>
            <input type="text" placeholder="Room Code" id="code"/>
            <button id="join">Join Room</button>
            <button id="create">Create Room</button>
        </div>

        <h2 class="hidden" id="roomCode">Room Code: 6PYX1</h2>
        <div class="container hidden" id="lobby">
            <h1>28</h1>
            <ul id="playerList">
            </ul>
            <button id="startGame">Start Game</button>
            <button id="leave">Leave Game</button>
        </div>

        <div class="hidden table" id="playingTable">
            <div class="opponent-table" id="oppTable">

            </div>

            <div class="table-middle card-container" id="tableMiddle">

            </div>

            <div class="my-cards card-container" id="myCards">
                
            </div>
        </div>
    </body>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js";

        // Your web app"s Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyAoUBDg6zn_-nmzB949LfQLE3cBF6U8VTs",
            authDomain: "twenty-eight-a7ba6.firebaseapp.com",
            databaseURL: "https://twenty-eight-a7ba6-default-rtdb.firebaseio.com",
            projectId: "twenty-eight-a7ba6",
            storageBucket: "twenty-eight-a7ba6.appspot.com",
            messagingSenderId: "566672343220",
            appId: "1:566672343220:web:1bdff83862b9f2e23c17e1",
            measurementId: "G-982J38XWP6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);

        import { getDatabase, set, get, update, remove, ref, child, onValue, off } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

        const db = getDatabase();

        var nameIn = document.querySelector("#name");
        var codeIn = document.querySelector("#code");
  
        var joinBtn = document.querySelector("#join");
        var createBtn = document.querySelector("#create");
        var leaveBtn = document.querySelector("#leave");
        var startBtn = document.querySelector("#startGame");

        var room;
        var playerID;
        var started = false;
        var listeners = [];
        var players;
        var hand = [];
        var middleCards = [];
        var turn;

        function reset() {
            room = null;
            playerID = null;
            started = false;
            players = null;

            document.getElementById("start").classList.remove("hidden");
            document.getElementById("roomCode").classList.add("hidden");
            document.getElementById("lobby").classList.add("hidden");

            var ul = document.getElementById("playerList");

            while(ul.firstChild) {
                ul.removeChild(ul.firstChild);
            }
            
            for (const ref of listeners) {
                off(ref);
            }
            listeners = [];
        }
        
        function addPlayers(snapshot) {
            players = snapshot.val();
            var ul = document.getElementById("playerList");

            while(ul.firstChild) {
                ul.removeChild(ul.firstChild);
            }
                        
            for (const name in players) {
                var li = document.createElement("li");
                li.appendChild(document.createTextNode(name));
                li.setAttribute("id", name);
                ul.appendChild(li);
                
                if (name == playerID) {
                    li.classList.add("me");
                }
            }
        }

        function updateGame(snapshot) {
            var data = snapshot.val();

            if ("curCards" in data) {
                middleCards = curCards;
            } else {
                middleCards = [];
            }

            players = data.players;
            hand = data.players[playerID].cards;
            started = data.started;

            drawAllCards();
        }

        function startUpdate(snapshot) {
            started = snapshot.val();

            if (started == true) {
                document.getElementById("lobby").classList.add("hidden");
                document.getElementById("playingTable").classList.remove("hidden");
                const dbref = ref(db);
                var newHand = [];

                get(child(dbref, "rooms/" + room))
                .then((snapshot) => {
                    if(snapshot.exists()){
                        var data = snapshot.val();

                        if (!(data.turn == playerID)) {
                            startUpdate(snapshot);
                            return;
                        }

                        for (let i = 0; i < 4; i++) {
                            const idx = Math.floor(Math.random() * data.cards.length);
                            const card = data.cards[idx];

                            data.cards.splice(idx, 1);
                            newHand.push(card);
                        }

                        hand = [...newHand];
                        data.players[playerID].cards = hand;

                        update(ref(db, "rooms/" + room), {
                            cards: data.cards,
                            players: data.players,
                        })
                        .catch((error)=>{
                            alert(error);
                        });

                        for (const ref of listeners) {
                            off(ref);
                        }

                        var roomRef = ref(db, "rooms/"+room);
                        listeners = [roomRef];

                        onValue(roomRef, (snapshot) => updateGame(snapshot), (error) => {
                            console.error("Error listening to changes:", error);
                        });

                        drawAllCards();
                    } else {
                        alert("Room does not exist");
                        leaveRoom();
                    }
                })
                .catch((error)=>{
                    alert(error);
                });
            } else {
                document.getElementById("lobby").classList.remove("hidden");
                document.getElementById("playingTable").classList.add("hidden");
            }
        }

        function createRoom() {
            const characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            let roomID = "";
            const charactersLength = characters.length;

            for (let i = 0; i < 5; i++) {
                roomID += characters.charAt(Math.floor(Math.random() * charactersLength));
            }

            const suits = ["spade", "heart", "diamond", "club"];
            const ranks = ["A", "K", "Q", "J", "10", "9"];
            const cards = {};
            let index = 0;

            for (const suit of suits) {
                for (const rank of ranks) {
                    cards[index] = `${rank} ${suit}`;
                    index++;
                }
            }

            playerID = nameIn.value;

            set(ref(db, "rooms/" + roomID),{
                players: {
                    [playerID]: {
                        chips: 0,
                    }
                },
                turn: playerID,
                trumpcard: "",
                callPoints: 0,
                curPoints: 0,
                caller: 0,
                cards: cards,
                curWinner: "",
                trumpcardRevealed: false,
                started: false,
            })
            .then(()=>{
                console.log("Room Created");

                room = roomID;
                playerID = nameIn.value;
                players = {
                    playerID: {
                        chips: 0,
                    }
                }

                document.getElementById("roomCode").innerHTML = `Room Code: ${room}`;
                document.getElementById("start").classList.add("hidden");
                document.getElementById("roomCode").classList.remove("hidden");
                document.getElementById("lobby").classList.remove("hidden");

                var ul = document.getElementById("playerList");
                var li = document.createElement("li");
                li.appendChild(document.createTextNode(name.value));
                li.setAttribute("id", playerID);
                ul.appendChild(li);
                li.classList.add("me");

                var playersRef = ref(db, "rooms/"+room+"/players");

                onValue(playersRef, (snapshot) => addPlayers(snapshot), (error) => {
                    console.error("Error listening to changes: ", error);
                });

                var startedRef = ref(db, "rooms/"+room+"/started");

                onValue(startedRef, (snapshot) => startUpdate(snapshot), (error) => {
                    console.error("Error listening to changes:", error);
                });

                listeners.push(playersRef);
                listeners.push(startedRef);
            })
            .catch((error)=>{
                alert(error);
            });
        }

        function joinRoom() {
            const dbref = ref(db);

            if (code.value == "") {
                alert("Please enter a code");
                return;
            }

            get(child(dbref, "rooms/" + codeIn.value))
            .then((snapshot)=>{
                if(snapshot.exists()){
                    var data = snapshot.val();

                    for (const name in data.players) {
                        if (name == nameIn.value) {
                            alert("Someone in room has the same name");
                            return;
                        }
                    }

                    room = codeIn.value;
                    playerID = nameIn.value;
                    data.players[playerID] = {
                        chips: 0,
                    }
                    players = data.players;

                    document.getElementById("roomCode").innerHTML = `Room Code: ${room}`;
                    document.getElementById("start").classList.add("hidden");
                    document.getElementById("roomCode").classList.remove("hidden");
                    document.getElementById("lobby").classList.remove("hidden");

                    update(ref(db, "rooms/" + room), {
                        players: players,
                    })
                    .catch((error)=>{
                        alert(error);
                    });

                    var ul = document.getElementById("playerList");
                    for (const name in players) {
                        var li = document.createElement("li");
                        li.appendChild(document.createTextNode(name));
                        li.setAttribute("id", playerID);
                        ul.appendChild(li);

                        if (name == playerID) {
                            li.classList.add("me");
                        }
                    }

                    var playersRef = ref(db, "rooms/"+room+"/players");

                    onValue(playersRef, (snapshot) => addPlayers(snapshot), (error) => {
                        console.error("Error listening to changes:", error);
                    });

                    var startedRef = ref(db, "rooms/"+room+"/started");

                    onValue(startedRef, (snapshot) => startUpdate(snapshot), (error) => {
                        console.error("Error listening to changes:", error);
                    });

                    listeners.push(playersRef);
                    listeners.push(startedRef);
                } else {
                    alert("No room with entered code");
                }
            })
            .catch((error)=>{
                alert(error);
            })
        }

        function leaveRoom() {
            delete players[playerID];

            if (Object.keys(players).length === 0) {
                remove(ref(db, "rooms/" + room))
                .catch((error)=>{
                    alert(error);
                });
            } else {
                update(ref(db, "rooms/" + room), {
                    players: players,
                })
                .catch((error)=>{
                    alert(error);
                });
            }

            reset();
        }

        function startGame() {
            started = true;
            console.log(room)

            update(ref(db, "rooms/" + room), {
                started: true,
            })
            .catch((error)=>{
                alert(error);
            });
        }

        function drawAllCards() {
            console.log(players)
            var myCards = document.getElementById("myCards");
            var middleTable = document.getElementById("tableMiddle");
            var oppTable = document.getElementById("oppTable");

            while(myCards.firstChild) {
                myCards.removeChild(myCards.firstChild);
            }

            while(middleTable.firstChild) {
                middleTable.removeChild(middleTable.firstChild);
            }

            while(oppTable.firstChild) {
                oppTable.removeChild(oppTable.firstChild);
            }

            var selfNameTag = document.createElement("h3");
            selfNameTag.innerHTML = "Me";
            myCards.appendChild(selfNameTag);

            for (var i = 0; i < hand.length; i++) {
                var card = hand[i];
                var [value, suit] = card.split(" ");
                var cardDiv = document.createElement("div");

                cardDiv.setAttribute("data-suit", suit);
                cardDiv.setAttribute("data-value", value);
                cardDiv.classList.add("card")

                myCards.appendChild(cardDiv);
            }

            for (var i = 0; i < middleCards.length; i++) {
                var card = middleCards[i];
                var [value, suit] = card.split(" ");
                var cardDiv = document.createElement("div");

                cardDiv.setAttribute("data-suit", suit);
                cardDiv.setAttribute("data-value", value);
                cardDiv.classList.add("card")

                middleCards.appendChild(cardDiv);
            }

            for (const name in players) {
                if (!("cards" in players[name])) {
                    continue;
                }

                var cardsDiv = document.createElement("div");
                cardsDiv.classList.add("card-container");
                cardsDiv.setAttribute("id", name);

                var nameTag = document.createElement("h3");
                nameTag.classList.add("name-tag");
                nameTag.innerHTML = name;

                cardsDiv.appendChild(nameTag);

                for (var i = 0; i < players[name].cards.length; i++) {
                    var card = players[name].cards[i];
                    var cardDiv = document.createElement("div");

                    cardDiv.setAttribute("data-value", "?");
                    cardDiv.classList.add("card")

                    cardsDiv.appendChild(cardDiv);
                }

                oppTable.appendChild(cardsDiv);
            }
        }

        createBtn.addEventListener("click", createRoom);
        joinBtn.addEventListener("click", joinRoom);
        leaveBtn.addEventListener("click", leaveRoom);
        startBtn.addEventListener("click", startGame);

        window.addEventListener("unload", function () {
            leaveRoom();
        });
    </script>
</html>
