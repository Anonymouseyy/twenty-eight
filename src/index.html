<!DOCTYPE html>
<html lang="en">
    <head>
        <link href="styles.css" rel="stylesheet">
        <link href="card.css" rel="stylesheet">

        <script src="card.js" defer></script>
 
        <title>Twenty Eight</title>
    </head>

    <body class="body-content">
        <div class="container" id="start">
            <h1>28</h1>
            <input type="text" placeholder="Name" id="name"/>
            <input type="text" placeholder="Room Code" id="code"/>
            <button id="join">Join Room</button>
            <button id="create">Create Room</button>
        </div>

        <h2 class="hidden" id="roomCode">Room Code: 6PYX1</h2>
        <div class="container hidden" id="lobby">
            <h1>28</h1>
            <ul id="playerList">
            </ul>
            <button id="start">Start Game</button>
            <button id="leave">Leave Game</button>
        </div>
    </body>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js";

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyAoUBDg6zn_-nmzB949LfQLE3cBF6U8VTs",
            authDomain: "twenty-eight-a7ba6.firebaseapp.com",
            databaseURL: "https://twenty-eight-a7ba6-default-rtdb.firebaseio.com",
            projectId: "twenty-eight-a7ba6",
            storageBucket: "twenty-eight-a7ba6.appspot.com",
            messagingSenderId: "566672343220",
            appId: "1:566672343220:web:1bdff83862b9f2e23c17e1",
            measurementId: "G-982J38XWP6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);

        import { getDatabase, set, get, update, remove, ref, child, onValue } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

        const db = getDatabase();

        var nameIn = document.querySelector("#name");
        var codeIn = document.querySelector("#code");
  
        var joinBtn = document.querySelector("#join");
        var createBtn = document.querySelector("#create");
        var leaveBtn = document.querySelector("#leave");
        var startBtn = document.querySelector("#start");

        var room;
        var playerID;
        var started = false;

        var players;

        function reset() {
            room = null;
            playerID = null;
            started = false;
            players = null;

            document.getElementById("start").classList.remove("hidden");
            document.getElementById("roomCode").classList.add("hidden");
            document.getElementById("lobby").classList.add("hidden");

            var ul = document.getElementById("playerList");

            while(ul.firstChild) {
                ul.removeChild(ul.firstChild);
            }
            
            db.off();
        }

        function createRoom() {
            const characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            let roomID = "";
            const charactersLength = characters.length;

            for (let i = 0; i < 5; i++) {
                roomID += characters.charAt(Math.floor(Math.random() * charactersLength));
            }

            const suits = ['Spades', 'Hearts', 'Diamonds', 'Clubs'];
            const ranks = ['A', 'K', 'Q', 'J', '10', '9'];
            const cards = {};
            let index = 0;

            for (const suit of suits) {
                for (const rank of ranks) {
                    cards[index] = `${rank} ${suit}`;
                    index++;
                }
            }

            playerID = nameIn.value;

            set(ref(db, "rooms/" + roomID),{
                players: {
                    [playerID]: {
                        points: 0,
                    }
                },
                turn: "",
                trumpcard: "",
                callpoints: 0,
                curpoints: 0,
                caller: 0,
                cards: cards,
                started: false,
            })
            .then(()=>{
                console.log("Room Created");

                room = roomID;
                playerID = nameIn.value;
                players = {
                    playerID: {
                        chips: 0,
                    }
                }

                document.getElementById("roomCode").innerHTML = `Room Code: ${room}`;
                document.getElementById("start").classList.add("hidden");
                document.getElementById("roomCode").classList.remove("hidden");
                document.getElementById("lobby").classList.remove("hidden");

                var ul = document.getElementById("playerList");
                var li = document.createElement("li");
                li.appendChild(document.createTextNode(name.value));
                li.setAttribute("id", playerID);
                ul.appendChild(li);
                li.classList.add("me");

                var playersRef = ref(db, "rooms/"+roomID+"/players");

                onValue(playersRef, (snapshot) => {
                    players = snapshot.val();
                    var ul = document.getElementById("playerList");

                    while(ul.firstChild) {
                        ul.removeChild(ul.firstChild);
                    }
                        
                    for (const name in players) {
                        var li = document.createElement("li");
                        li.appendChild(document.createTextNode(name));
                        li.setAttribute("id", name);
                        ul.appendChild(li);

                        if (name == playerID) {
                            li.classList.add("me");
                        }
                    }
                }, (error) => {
                    console.error("Error listening to changes: ", error);
                });

                var startedRef = ref(db, "rooms/"+room+"/started");

                onValue(startedRef, (snapshot) => {
                    started = snapshot.val();

                    if (started == true) {
                        document.getElementById("lobby").classList.add("hidden");
                    } else {
                        document.getElementById("lobby").classList.remove("hidden");
                    }
                }, (error) => {
                    console.error('Error listening to changes:', error);
                });
            })
            .catch((error)=>{
                alert(error);
            });
        }

        function joinRoom() {
            const dbref = ref(db);

            if (code.value == "") {
                alert("Please enter a code");
                return;
            }

            get(child(dbref, "rooms/" + codeIn.value))
            .then((snapshot)=>{
                if(snapshot.exists()){
                    var data = snapshot.val();

                    for (const name in data.players) {
                        if (name == nameIn.value) {
                            alert("Someone in room has the same name");
                            return;
                        }
                    }

                    room = codeIn.value;
                    playerID = nameIn.value;
                    data.players[playerID] = {
                        chips: 0,
                    }
                    players = data.players;

                    document.getElementById("roomCode").innerHTML = `Room Code: ${room}`;
                    document.getElementById("start").classList.add("hidden");
                    document.getElementById("roomCode").classList.remove("hidden");
                    document.getElementById("lobby").classList.remove("hidden");

                    update(ref(db, "rooms/" + room), {
                        players: players,
                    })
                    .catch((error)=>{
                        alert(error);
                    });

                    var ul = document.getElementById("playerList");
                    for (const name in players) {
                        var li = document.createElement("li");
                        li.appendChild(document.createTextNode(name));
                        li.setAttribute("id", playerID);
                        ul.appendChild(li);

                        if (name == playerID) {
                            li.classList.add("me");
                        }
                    }

                    var playersRef = ref(db, "rooms/"+room+"/players");

                    onValue(playersRef, (snapshot) => {
                        players = snapshot.val();
                        var ul = document.getElementById("playerList");

                        while(ul.firstChild) {
                            ul.removeChild(ul.firstChild);
                        }
                        
                        for (const name in players) {
                            var li = document.createElement("li");
                            li.appendChild(document.createTextNode(name));
                            li.setAttribute("id", name);
                            ul.appendChild(li);

                            if (name == playerID) {
                                li.classList.add("me");
                            }
                        }
                    }, (error) => {
                        console.error('Error listening to changes:', error);
                    });

                    var startedRef = ref(db, "rooms/"+room+"/started");

                    onValue(startedRef, (snapshot) => {
                        started = snapshot.val();

                        if (started == true) {
                            document.getElementById("lobby").classList.add("hidden");
                        } else {
                            document.getElementById("lobby").classList.remove("hidden");
                        }
                    }, (error) => {
                        console.error('Error listening to changes:', error);
                    });
                } else {
                    alert("No room with entered code");
                }
            })
            .catch((error)=>{
                alert(error);
            })
        }

        function leaveRoom() {
            delete players[playerID];
            update(ref(db, "rooms/" + room), {
                players: players,
            })
            .catch((error)=>{
                alert(error);
            });

            reset();
        }

        function startGame() {
            started = true;

            update(ref(db, "rooms/" + room), {
                started: true,
            })
            .catch((error)=>{
                alert(error);
            });
        }

        createBtn.addEventListener("click", createRoom);
        joinBtn.addEventListener("click", joinRoom);
        leaveBtn.addEventListener("click", leaveRoom);
        startBtn.addEventListener("click", startGame);
    </script>
</html>
